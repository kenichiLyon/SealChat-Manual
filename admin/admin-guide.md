# 管理员指南

本指南面向 SealChat 的系统管理员和世界管理员，介绍系统管理和配置的相关内容。

---

## 管理员类型

SealChat 中有两种管理员角色：

| 角色 | 权限范围 | 说明 |
|------|----------|------|
| **系统管理员** | 全局 | 管理整个 SealChat 实例 |
| **世界管理员** | 单个世界 | 管理特定世界的设置和成员 |

::: tip 首个用户
首个注册的用户会自动成为系统管理员。
:::

---

## 管理后台入口

### 访问管理后台

1. 使用管理员账号登录
2. 点击页面右上角的用户头像
3. 选择"管理后台"或直接访问 `/admin`

### 管理后台功能

| 功能模块 | 说明 |
|----------|------|
| 用户管理 | 查看、编辑、禁用用户账号 |
| Bot 管理 | 创建和管理自动化 Bot |
| 系统配置 | 调整系统级设置 |
| 存储迁移 | S3 存储迁移工具 |
| 系统状态 | 查看运行状态和指标 |

---

## 用户管理

### 查看用户列表

1. 进入管理后台 → 用户管理
2. 可以看到所有注册用户
3. 支持按用户名、注册时间等筛选

### 用户信息

| 字段 | 说明 |
|------|------|
| 用户名 | 登录账号 |
| 昵称 | 显示名称 |
| 邮箱 | 绑定的邮箱地址 |
| 注册时间 | 账号创建时间 |
| 最后登录 | 最近一次登录时间 |
| 状态 | 正常/禁用 |
| 角色 | 普通用户/管理员 |

### 编辑用户

1. 在用户列表中找到目标用户
2. 点击"编辑"按钮
3. 可修改的内容：
   - 昵称
   - 密码（重置）
   - 角色权限
   - 账号状态

### 禁用用户

1. 找到需要禁用的用户
2. 点击"禁用"按钮
3. 确认操作

::: warning 注意
禁用后，该用户将无法登录，但其发送的消息等数据会保留。
:::

### 删除用户

::: danger 危险操作
删除用户会同时删除该用户的所有相关数据，此操作不可恢复。
:::

1. 找到需要删除的用户
2. 点击"删除"按钮
3. 输入确认信息
4. 确认删除

---

## Bot 管理

Bot 是 SealChat 中的自动化账号，可用于集成外部服务或实现自动化功能。

### 创建 Bot

1. 进入管理后台 → Bot 管理
2. 点击"创建 Bot"
3. 填写 Bot 信息：
   - **名称**：Bot 的显示名称
   - **描述**：Bot 的功能说明
4. 创建成功后获得 **Token**

::: warning Token 安全
Token 是 Bot 的唯一身份凭证，请妥善保管，不要泄露给他人。
:::

### Bot Token

```
格式：sc_bot_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

Token 用于：
- API 身份验证
- WebSocket 连接
- 消息发送和接收

### 管理 Bot

| 操作 | 说明 |
|------|------|
| 编辑 | 修改 Bot 名称和描述 |
| 重置 Token | 生成新的 Token（旧 Token 失效） |
| 禁用 | 临时禁用 Bot |
| 删除 | 删除 Bot 及其 Token |

### Bot 权限

Bot 的权限与普通用户类似：
- 需要加入世界才能在该世界发言
- 受频道权限限制
- 可以使用身份卡

### Bot 集成示例

**Python 示例**：

```python
import requests

BOT_TOKEN = "sc_bot_xxxxxxxx"
API_BASE = "http://localhost:3212/api"

headers = {
    "Authorization": f"Bearer {BOT_TOKEN}"
}

# 发送消息
response = requests.post(
    f"{API_BASE}/channel/{channel_id}/messages",
    headers=headers,
    json={"content": "Hello from Bot!"}
)
```

---

## 世界管理

### 进入世界设置

1. 进入目标世界
2. 点击世界名称旁的设置图标
3. 或直接访问 `/world/{id}/settings`

### 世界基本设置

| 设置 | 说明 |
|------|------|
| 世界名称 | 修改世界的显示名称 |
| 世界描述 | 修改世界的简介 |
| 世界图标 | 上传新的世界图标 |
| 公开状态 | 切换公开/私有 |

### 成员管理

**查看成员**：
- 成员列表显示所有世界成员
- 可以查看成员的加入时间、角色等

**添加成员**：
1. 点击"添加成员"
2. 搜索用户名
3. 选择并添加

**移除成员**：
1. 在成员列表找到目标用户
2. 点击"移除"
3. 确认操作

**设置管理员**：
1. 找到要提升的成员
2. 点击"设为管理员"
3. 该成员获得世界管理权限

### 邀请管理

**生成邀请链接**：
1. 进入邀请管理
2. 点击"生成邀请链接"
3. 可设置：
   - 有效期（永久/7天/24小时/1小时）
   - 最大使用次数
4. 复制生成的链接

**查看邀请记录**：
- 查看所有生成的邀请链接
- 查看使用情况
- 可以撤销未过期的邀请

### 转让世界

1. 进入世界设置 → 高级
2. 点击"转让世界"
3. 选择新的世界所有者
4. 确认转让

::: warning 注意
转让后，你将失去世界所有权，但保留管理员权限。
:::

### 删除世界

::: danger 危险操作
删除世界会同时删除该世界的所有频道、消息、附件等数据，此操作不可恢复。
:::

1. 进入世界设置 → 高级
2. 点击"删除世界"
3. 输入世界名称确认
4. 确认删除

---

## 频道管理

### 创建频道

1. 在世界左侧栏点击"+"按钮
2. 填写频道信息：
   - 频道名称
   - 频道描述
   - 父级频道（可选，用于创建子频道）
3. 确认创建

### 频道设置

| 设置 | 说明 |
|------|------|
| 基本信息 | 名称、描述 |
| 权限设置 | 频道级权限覆盖 |
| 身份卡 | 管理频道内的身份卡 |
| 骰子宏 | 配置该频道的骰子宏 |
| iForm | 嵌入表单配置 |
| 便签 | 频道顶部公告 |

### 频道权限

频道权限可以覆盖世界级别的默认权限：

| 权限 | 说明 |
|------|------|
| 查看频道 | 是否能看到该频道 |
| 发送消息 | 是否能发言 |
| 管理消息 | 是否能删除他人消息 |
| 管理频道 | 是否能编辑频道设置 |

### 删除频道

1. 进入频道设置
2. 点击"删除频道"
3. 确认操作

---

## 存储管理

### 存储模式

SealChat 支持三种存储模式：

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| **local** | 本地文件存储 | 单机部署、小规模 |
| **s3** | S3 兼容存储 | 大规模、需要 CDN |
| **auto** | 自动选择 | 混合场景 |

### 本地存储

默认存储位置：
```
./sealchat-data/upload/    # 附件
./static/audio/            # 音频
./data/exports/            # 导出文件
```

### S3 存储配置

在 `config.yaml` 中配置：

```yaml
storage:
  mode: s3
  s3:
    enabled: true
    endpoint: "https://s3.amazonaws.com"
    bucket: "sealchat-files"
    region: "us-east-1"
```

环境变量：
```bash
SEALCHAT_S3_ACCESS_KEY=your_access_key
SEALCHAT_S3_SECRET_KEY=your_secret_key
```

### S3 迁移

从本地存储迁移到 S3：

1. 配置好 S3 连接
2. 进入管理后台 → 存储迁移
3. 选择迁移范围
4. 开始迁移
5. 等待完成

---

## 监控与维护

### 系统状态页面

访问 `/status` 查看：

| 指标 | 说明 |
|------|------|
| 在线用户数 | 当前连接的用户数量 |
| WebSocket 连接数 | 当前活跃的 WebSocket 连接 |
| 消息速率 | 每分钟消息发送量 |
| 数据库大小 | SQLite 数据库文件大小 |

### 健康检查

```bash
curl http://localhost:3212/status/health
```

返回：
```json
{
  "status": "ok",
  "uptime": "24h30m",
  "version": "1.0.0"
}
```

### 日志查看

**Docker 部署**：
```bash
docker logs sealchat
docker logs -f sealchat  # 实时查看
```

**二进制部署**：
日志输出到标准输出，可以重定向到文件：
```bash
./sealchat_server > sealchat.log 2>&1
```

### 数据库维护

**备份 SQLite 数据库**：
```bash
# 停止服务后复制
cp ./data/chat.db ./backup/chat_$(date +%Y%m%d).db

# 或使用 SQLite 命令（无需停止服务）
sqlite3 ./data/chat.db ".backup './backup/chat_backup.db'"
```

**优化数据库**：
```bash
sqlite3 ./data/chat.db "VACUUM;"
sqlite3 ./data/chat.db "ANALYZE;"
```

---

## 常见管理任务

### 重置用户密码

1. 进入管理后台 → 用户管理
2. 找到用户
3. 点击"重置密码"
4. 输入新密码
5. 通知用户新密码

### 处理违规内容

1. 在消息上右键 → 删除
2. 或进入管理后台批量处理
3. 记录处理原因

### 处理存储空间不足

1. 检查大文件：
   ```bash
   du -sh ./sealchat-data/*
   du -sh ./static/*
   ```
2. 清理过期的导出文件
3. 考虑迁移到 S3

### 紧急情况处理

**服务无响应**：
```bash
# Docker
docker restart sealchat

# 二进制
# 终止进程后重启
```

**数据库锁定**：
```bash
# 检查锁定
sqlite3 ./data/chat.db ".databases"

# 如有必要，重启服务释放锁
```
