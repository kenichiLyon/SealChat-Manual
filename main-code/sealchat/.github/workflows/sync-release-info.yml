name: Sync Release Metadata with PR
# ä¸“é—¨ç”¨äºæ‰‹åŠ¨è§¦å‘ï¼Œå›æº¯æ›´æ–° Release ä¿¡æ¯
on:
  workflow_dispatch:
    inputs:
      limit:
        description: 'è¦å¤„ç†çš„æœ€è¿‘ Release æ•°é‡ (é»˜è®¤ 30)'
        required: true
        default: '30'
      dry_run:
        description: 'ä»…æ¨¡æ‹Ÿè¿è¡Œ (ä¸å®é™…ä¿®æ”¹)'
        required: true
        type: boolean
        default: false
      force_update:
        description: 'å³ä½¿æ‰¾ä¸åˆ° PR ä¹Ÿå¼ºåˆ¶æ›´æ–° (æ…é€‰)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write      # éœ€è¦ä¿®æ”¹ Release
  pull-requests: read  # éœ€è¦è¯»å– PR ä¿¡æ¯

jobs:
  sync-releases:
    name: Sync Releases
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å¿…é¡»æ‹‰å–å®Œæ•´å†å²ï¼Œå¦åˆ™æ— æ³•é€šè¿‡ Tag æ‰¾åˆ° Commit

      - name: Process Releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LIMIT: ${{ inputs.limit }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          echo "ğŸ” å¼€å§‹è·å–æœ€è¿‘ $LIMIT ä¸ª Release..."
          
          # è·å– Release åˆ—è¡¨ (JSON æ ¼å¼)
          gh release list --limit "$LIMIT" --json tagName,isDraft,isPrerelease > releases.json

          # éå†æ¯ä¸€ä¸ª Release
          jq -c '.[]' releases.json | while read -r release_json; do
            TAG_NAME=$(echo "$release_json" | jq -r '.tagName')
            
            echo "---------------------------------------------------"
            echo "ğŸ“¦ æ­£åœ¨å¤„ç† Release: $TAG_NAME"

            # 1. è·å–è¯¥ Tag å¯¹åº”çš„ Commit SHA
            # è¿™æ˜¯ä¸€ä¸ªå…³é”®æ­¥éª¤ï¼Œæˆ‘ä»¬éœ€è¦ Tag æŒ‡å‘çš„é‚£ä¸ª Commit ID
            COMMIT_SHA=$(git rev-list -n 1 "$TAG_NAME" 2>/dev/null || echo "")

            if [ -z "$COMMIT_SHA" ]; then
              echo "âš ï¸  æ— æ³•è§£æ Tag $TAG_NAME çš„ Commit SHAï¼Œè·³è¿‡ã€‚"
              continue
            fi
            echo "   ğŸ”— Commit SHA: $COMMIT_SHA"

            # 2. æŸ¥æ‰¾å…³è”çš„ Merged PR
            # æœç´¢åŒ…å«æ­¤ SHA ä¸”çŠ¶æ€ä¸º merged çš„ PR
            PR_DATA=$(gh pr list --search "$COMMIT_SHA" --state merged --json number,title,body --limit 1)
            PR_NUMBER=$(echo "$PR_DATA" | jq -r '.[0].number')

            if [ "$PR_NUMBER" != "null" ] && [ -n "$PR_NUMBER" ]; then
              # 3. æå– PR ä¿¡æ¯
              NEW_TITLE=$(echo "$PR_DATA" | jq -r '.[0].title')
              NEW_BODY=$(echo "$PR_DATA" | jq -r '.[0].body')
              
              echo "   âœ… æ‰¾åˆ°å…³è” PR #$PR_NUMBER: $NEW_TITLE"

              # 4. æ‰§è¡Œæ›´æ–°
              if [ "$DRY_RUN" == "true" ]; then
                echo "   [æ¨¡æ‹Ÿè¿è¡Œ] å°†ä¼šæŠŠæ ‡é¢˜æ›´æ–°ä¸º: $NEW_TITLE"
              else
                echo "   ğŸš€ æ­£åœ¨æ›´æ–° Release..."
                # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶å¤„ç†å¤šè¡Œ Bodyï¼Œé¿å…è½¬ä¹‰é—®é¢˜
                echo "$NEW_BODY" > release_body_temp.txt
                
                gh release edit "$TAG_NAME" \
                  --title "$NEW_TITLE" \
                  --notes-file release_body_temp.txt
                
                echo "   âœ¨ æ›´æ–°æˆåŠŸï¼"
                rm release_body_temp.txt
              fi

            else
              echo "   â„¹ï¸  æœªæ‰¾åˆ°å…³è”çš„ PR (å¯èƒ½æ˜¯ç›´æ¥ Push åˆ°åˆ†æ”¯çš„)ã€‚"
              echo "   â­ï¸  ä¿æŒåŸæ ·è·³è¿‡ã€‚"
            fi
          done
